/**
 * ðŸŒ³ BlogSpy Complete Tree Generator
 * 
 * Generates a clean, comprehensive tree structure of the project
 * excluding dependencies, caches, and IDE configs.
 * 
 * Usage: node scripts/generate-blogspy-tree.mjs
 * Output: BLOGSPY_COMPLETE_STRUCTURE.md
 */

import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT = path.resolve(__dirname, "..");

// ============================================
// EXCLUSION RULES
// ============================================

const EXCLUDE_DIRS = new Set([
    // Dependencies & Build
    "node_modules",
    ".next",
    ".venv",

    // IDE & Editor
    ".cursor",
    ".vscode",
    ".kilocode",
    ".roo",
    ".idea",

    // Git
    ".git",
    ".github",

    // Backups & Assets
    "backups",
    "screenshots",
    "assets",
    "public/assets",

    // Test & Reports
    "playwright-report",
    "test-results",
    "coverage",

    // Cache
    ".turbo",
]);

const EXCLUDE_FILES = new Set([
    // Build artifacts
    "tsconfig.tsbuildinfo",
    "package-lock.json",
    "yarn.lock",
    "pnpm-lock.yaml",

    // Configs
    ".DS_Store",
    "Thumbs.db",
]);

const EXCLUDE_PATTERNS = [
    /\.md$/i,
    /\.txt$/i,
    /\.log$/i,
    /^\.env/,
];

// ============================================
// TREE BUILDING
// ============================================

function shouldExclude(name, isDir) {
    if (isDir && EXCLUDE_DIRS.has(name)) return true;
    if (!isDir && EXCLUDE_FILES.has(name)) return true;
    if (!isDir) {
        for (const pattern of EXCLUDE_PATTERNS) {
            if (pattern.test(name)) return true;
        }
    }
    return false;
}

function buildTree(dirPath, prefix = "", isLast = true) {
    const lines = [];

    try {
        const entries = fs.readdirSync(dirPath, { withFileTypes: true })
            .filter(e => !shouldExclude(e.name, e.isDirectory()))
            .sort((a, b) => {
                // Directories first
                if (a.isDirectory() && !b.isDirectory()) return -1;
                if (!a.isDirectory() && b.isDirectory()) return 1;
                return a.name.localeCompare(b.name);
            });

        entries.forEach((entry, index) => {
            const isLastEntry = index === entries.length - 1;
            const connector = isLastEntry ? "â””â”€â”€ " : "â”œâ”€â”€ ";
            const childPrefix = prefix + (isLastEntry ? "    " : "â”‚   ");
            const fullPath = path.join(dirPath, entry.name);

            if (entry.isDirectory()) {
                lines.push(`${prefix}${connector}ðŸ“ ${entry.name}/`);
                const childLines = buildTree(fullPath, childPrefix, isLastEntry);
                lines.push(...childLines);
            } else {
                lines.push(`${prefix}${connector}${entry.name}`);
            }
        });
    } catch (err) {
        lines.push(`${prefix}[Error reading directory: ${err.message}]`);
    }

    return lines;
}

function countFiles(dirPath) {
    let count = { files: 0, dirs: 0 };

    try {
        const entries = fs.readdirSync(dirPath, { withFileTypes: true })
            .filter(e => !shouldExclude(e.name, e.isDirectory()));

        for (const entry of entries) {
            if (entry.isDirectory()) {
                count.dirs++;
                const subCount = countFiles(path.join(dirPath, entry.name));
                count.files += subCount.files;
                count.dirs += subCount.dirs;
            } else {
                count.files++;
            }
        }
    } catch (err) {
        // Ignore errors
    }

    return count;
}

// ============================================
// MAIN
// ============================================

console.log("ðŸŒ³ Generating BlogSpy Complete Tree Structure...\n");

const timestamp = new Date().toISOString().split("T")[0];
const counts = countFiles(ROOT);

const output = [
    `# ðŸŒ³ BlogSpy Complete Tree Structure`,
    ``,
    `**Generated:** ${timestamp}`,
    `**Total Files:** ${counts.files}`,
    `**Total Directories:** ${counts.dirs}`,
    ``,
    `## Exclusions`,
    `- Dependencies: node_modules, .next, .venv`,
    `- IDE configs: .cursor, .vscode, .kilocode`,
    `- Git: .git, .github`,
    `- Caches: backups, screenshots, *.log, tsconfig.tsbuildinfo`,
    `- Previously generated tree files`,
    ``,
    `---`,
    ``,
    `## Project Structure`,
    ``,
    "```",
    `blogspy-saas/`,
    ...buildTree(ROOT),
    "```",
    ``,
    `---`,
    ``,
    `*Auto-generated by scripts/generate-blogspy-tree.mjs*`,
];

const outputPath = path.join(ROOT, "BLOGSPY_COMPLETE_STRUCTURE.md");
fs.writeFileSync(outputPath, output.join("\n"), "utf8");

console.log(`âœ… Generated: BLOGSPY_COMPLETE_STRUCTURE.md`);
console.log(`ðŸ“Š Stats: ${counts.files} files, ${counts.dirs} directories`);
console.log(`\nðŸŽ‰ Done! Open BLOGSPY_COMPLETE_STRUCTURE.md to see the tree.`);
